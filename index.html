<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMEGA Bingo - Panel Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        // üö® TU CONFIGURACI√ìN DE FIREBASE üö®
        const firebaseConfig = {
            apiKey: "AIzaSyCwrGuhYZkfnH-Yva8CwaEMfEYhzCByrRA",
            authDomain: "omegareserva369-34542.firebaseapp.com",
            databaseURL: "https://omegareserva369-34542-default-rtdb.firebaseio.com",
            projectId: "omegareserva369-34542",
            storageBucket: "omegareserva369-34542.firebasestorage.app",
            messagingSenderId: "1023263517856",
            appId: "1:1023263517856:web:8dec670aac92b8693a6dc5"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #2e004f 0%, #6b00b6 100%);
            background-size: 400% 400%;
            animation: gradient-flow 15s ease infinite;
            overflow-x: hidden;
        }
        @keyframes gradient-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .bingo-card-image { max-width: 100%; height: auto; border-radius: 0.75rem; border: 4px solid #800080; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        #footer-logo { max-width: 150px; height: auto; cursor: pointer; transition: transform 0.1s; }
        #footer-logo:active { transform: scale(0.9); }

        /* Modal Generico */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .modal-content { background-color: white; border-radius: 1rem; padding: 1.5rem; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; }
        
        /* Modal Legal */
        .modal-legal-content { background-color: white; border-radius: 1rem; padding: 1.5rem; width: 95%; max-width: 800px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; max-height: 90vh; }
        .modal-legal-body { overflow-y: auto; max-height: 70vh; padding: 1rem 0;}

        /* Modal Cerrado (Estilo especial JUEGO) */
        .closed-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: white; /* FONDO BLANCO PARA EL JUEGO */
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 9999; text-align: center; color: #1f2937;
        }
        
        canvas {
            border-bottom: 2px solid #5b21b6;
            background: transparent;
            touch-action: manipulation; /* Mejora respuesta t√°ctil */
        }

        /* Botones de Bingo */
        .card-item-container { display: flex; flex-direction: column; align-items: center; padding: 2px; cursor: pointer; transition: transform 0.1s; }
        .card-item-container:hover { transform: scale(1.05); }
        
        .bingo-ball { width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 900; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 2; position: relative;}
        .ver-tag { font-size: 10px; font-weight: bold; background-color: #fcd34d; color: #1f2937; padding: 1px 6px; margin-top: 4px; border-radius: 4px; border: 1px solid #fbbf24; z-index: 2; position: relative; }
        .ver-tag:hover { background-color: #fbbf24; }

        /* Estados de Color */
        .status-available .bingo-ball { background-color: #6b21a8; color: white; border: 2px solid #5b21b6; }
        .status-selected .bingo-ball { background-color: #fcd34d; color: #1f2937; border: 2px solid #fbbf24; transform: scale(1.1); }
        .status-reserved .bingo-ball { background-color: #f97316; color: white; border: 2px solid #ea580c; animation: pulse-orange 2s infinite; }
        .status-sold .bingo-ball { background-color: #16a34a; color: white; border: 2px solid #15803d; }

        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }

        .omega-title { font-family: 'Poppins', sans-serif; font-weight: 900; font-size: 3rem; line-height: 1; text-shadow: 2px 2px 0 #5b21b6; color: #fcd34d; }
        #countdownTimer { font-size: 2.5rem; font-weight: 900; color: #fcd34d; text-shadow: 2px 2px 0 #5b21b6; }
        
        /* Panel Admin */
        .admin-panel { min-height: 100vh; background: #f3f4f6; padding: 2rem; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="min-h-screen">

    <div id="closedStoreOverlay" class="closed-overlay select-none">
        <div id="adminSecretLock" class="absolute top-5 right-5 text-gray-300 cursor-pointer p-2 opacity-30 hover:opacity-100 z-50">
            <i class="fas fa-lock fa-lg"></i>
        </div>

        <div class="relative w-full max-w-lg h-full flex flex-col justify-center items-center">
            
            <div class="absolute top-10 text-center w-full px-4">
                <h2 class="text-2xl font-black text-purple-800 mb-1 uppercase tracking-wide">¬°A√∫n estamos cerrados!</h2>
                <p class="text-gray-500 text-sm font-bold mb-2">Reservas a partir de las 8:00 AM</p>
                <div class="inline-block bg-yellow-400 text-purple-900 font-black px-4 py-1 rounded-full text-sm shadow-md">
                    SCORE: <span id="gameScore">0</span>
                </div>
            </div>

            <div class="relative w-full h-[300px] flex items-center justify-center bg-white overflow-hidden" id="gameContainer" onclick="jumpDino()">
                <canvas id="dinoCanvas"></canvas>
                
                <div id="gameMessage" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-10">
                    <p class="text-purple-800 font-black text-xl mb-2" id="msgTitle">¬°JUEGA MIENTRAS ESPERAS!</p>
                    <p class="text-gray-600 text-sm mb-4">Toca la pantalla para saltar</p>
                    <button onclick="startGame()" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:scale-105 transition-transform animate-pulse">
                        EMPEZAR A CORRER üöÄ
                    </button>
                </div>
            </div>

            <p class="mt-8 text-gray-400 text-xs text-center px-6">
                Pr√≥ximo Bingo para el 11/12/25 - 7:00 PM<br>
                ¬°Partidas EN VIVO por Whatsapp!
            </p>
            
            <div class="mt-4 border-t border-gray-100 pt-4 w-1/2 mx-auto text-center">
                <p class="text-[10px] text-gray-300 font-bold tracking-widest">¬© OMEGA BINGO SYSTEM</p>
            </div>
        </div>
    </div>
    <div id="adminPanel" class="admin-panel hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-md">
                <h1 class="text-2xl font-extrabold text-purple-800">üîê Panel de Control OMEGA</h1>
                <button onclick="adminLogout()" class="px-4 py-2 bg-red-500 text-white font-bold rounded hover:bg-red-600">Salir</button>
            </div>

            <div id="adminLogin" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-700">Iniciar Sesi√≥n Admin</h2>
                <input type="email" id="adminEmail" placeholder="Correo" class="w-full p-3 border rounded mb-3">
                <input type="password" id="adminPassword" placeholder="Contrase√±a" class="w-full p-3 border rounded mb-4">
                <button onclick="adminLogin()" class="w-full py-3 bg-purple-600 text-white font-bold rounded hover:bg-purple-700">ENTRAR</button>
                <p id="adminLoginError" class="text-red-500 text-sm mt-3 hidden"></p>
            </div>

            <div id="adminDashboard" class="hidden space-y-8">
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-purple-600 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">üè™ Estado de la Tienda</h2>
                        <p id="storeStatusText" class="text-sm text-gray-500">Cargando estado...</p>
                    </div>
                    <button id="toggleStoreBtn" onclick="toggleStoreStatus()" class="px-6 py-3 rounded-lg font-black text-white transition-colors shadow-lg">
                        CARGANDO...
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-yellow-400">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        ‚ö†Ô∏è Pagos Pendientes por Confirmar (<span id="pendingCount">0</span>)
                    </h2>
                    <div id="pendingCardsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-green-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">‚úÖ Historial de Ventas (<span id="soldCount">0</span>)</h2>
                        <button onclick="downloadSoldList()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Descargar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 uppercase font-bold">
                                <tr><th class="p-3">Nombre</th><th class="p-3">Tlf</th><th class="p-3">Tablas</th><th class="p-3">Acci√≥n</th></tr>
                            </thead>
                            <tbody id="soldPlayersTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="clientContent">
        <div class="max-w-xl mx-auto p-4 pb-20">
            <div class="bg-yellow-400 p-4 rounded-t-xl text-center shadow-lg border-b-4 border-purple-800 mb-4">
                <p class="font-black text-xl text-gray-900">¬°OMEGA BINGO MAYOR!</p>
                <div class="mt-2 p-2 bg-purple-800 rounded-lg">
                    <p class="text-purple-200 text-xs font-bold uppercase tracking-widest">
                        Pr√≥ximo Juego: <span id="bingoDateDisplay">--</span>
                    </p>
                    <div id="countdownTimer">--:--:--</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg text-center mb-6 border border-gray-200">
                <p class="font-bold text-gray-600">Valor de la Tabla</p>
                <p class="text-3xl font-black text-green-600">Bs. 300,00</p>
                <div class="mt-2 flex justify-center gap-4 text-sm">
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-bold">Disponibles: <span id="availableCount">--</span></span>
                </div>
            </div>

            <div class="text-center mb-8">
                <h1 class="omega-title">OMEGA</h1>
                <p class="omega-subtitle">Sistema de Reserva Online</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-xl mb-8 border-l-4 border-purple-600">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    Datos Pago M√≥vil
                </h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex justify-between border-b pb-1"><span>Banco:</span> <span class="font-bold text-gray-900 cursor-pointer" onclick="copyToClipboard('0108')">0108 (Provincial) üìã</span></div>
                    <div class="flex justify-between border-b pb-1"><span>C√©dula:</span> <span class="font-bold text-gray-900 cursor-pointer" onclick="copyToClipboard('25822059')">V25822059 üìã</span></div>
                    <div class="flex justify-between"><span>Tel√©fono:</span> <span class="font-bold text-gray-900 cursor-pointer" onclick="copyToClipboard('04129546751')">04129546751 üìã</span></div>
                </div>
            </div>

            <button onclick="showCardSelectionModal()" class="w-full py-4 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-black text-xl rounded-xl shadow-xl hover:scale-[1.02] transition-transform mb-8 uppercase tracking-wide">
                Comprar Tablas üéüÔ∏è
            </button>

            <div class="grid gap-4">
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="font-bold text-gray-700 mb-2">üîç Consultar por Tel√©fono</h3>
                    <div class="flex gap-2">
                        <input type="tel" id="searchPhoneInput" placeholder="Ej: 0412..." class="w-full p-2 border rounded bg-gray-50">
                        <button onclick="searchCardByPhone()" class="bg-purple-600 text-white px-4 rounded font-bold">Ver</button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="font-bold text-gray-700 mb-2">üÜî Ver Tabla Individual</h3>
                    <div class="flex gap-2">
                        <input type="number" id="cardNumberInput" placeholder="N¬∞ Tabla" class="w-full p-2 border rounded bg-gray-50">
                        <button onclick="searchCard()" class="bg-purple-600 text-white px-4 rounded font-bold">Ver</button>
                    </div>
                </div>
            </div>

            <div id="searchResultArea" class="hidden mt-6 bg-white p-4 rounded-xl shadow-xl text-center border-2 border-purple-100">
                <h3 id="resultTitle" class="font-bold text-lg text-purple-800 mb-2"></h3>
                <div id="resultContent" class="flex justify-center flex-wrap gap-4"></div>
                <p id="resultStatus" class="text-sm font-bold mt-2"></p>
            </div>

            <div class="mt-12 text-center">
                <img src="logo-omega-bingo.png" id="footer-logo" class="mx-auto w-24 rounded-full shadow-lg bg-white p-1" alt="Logo">
                <h3 class="text-xl font-bold text-white mb-4">S√≠guenos en Redes Sociales</h3>
                <div class="flex justify-center space-x-6 mb-6">
                    <a href="https://wa.me/584226431972" target="_blank" class="text-white hover:text-green-400 transition-colors" title="WhatsApp">
                        <i class="fab fa-whatsapp fa-3x" style="color:#25D366;"></i>
                    </a>
                    <a href="https://www.facebook.com/OmegabingoAA/" target="_blank" class="text-white hover:text-blue-600 transition-colors" title="Facebook">
                        <i class="fab fa-facebook fa-3x"></i>
                    </a>
                    <a href="https://www.instagram.com/omega_bingo?igsh=MTY4czZ0NDltZ2gxZA==" target="_blank" class="text-white hover:text-pink-600 transition-colors" title="Instagram">
                        <i class="fab fa-instagram fa-3x"></i>
                    </a>
                </div>

                <div class="flex justify-center space-x-4 mb-6 text-sm">
                    <button onclick="showLegalModal('terms')" class="text-yellow-300 font-bold hover:underline">T√©rminos y Condiciones</button>
                    <span class="text-purple-300">|</span>
                    <button onclick="showLegalModal('privacy')" class="text-yellow-300 font-bold hover:underline">Pol√≠tica de Privacidad</button>
                </div>

                <p class="text-xs text-purple-200 mt-4">¬© OMEGA Bingo / Masson 2025. Todos los derechos reservados</p>
                <img src="logo-masson-bingo.png" id="footer-logo-masson" class="h-auto w-16 inline-block" alt="logo"> 
            </div>
            </div>
    </div>

    <div id="cardSelectionModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Selecciona tus Tablas</h3>
                <button onclick="hideCardSelectionModal()" class="text-2xl text-gray-500">&times;</button>
            </div>
            
            <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-4 px-2">
                <span class="flex items-center"><div class="w-3 h-3 bg-purple-700 rounded-full mr-1"></div> Libre</span>
                <span class="flex items-center"><div class="w-3 h-3 bg-yellow-400 rounded-full mr-1"></div> Tuya</span>
                <span class="flex items-center"><div class="w-3 h-3 bg-orange-500 rounded-full mr-1"></div> Ocupada</span>
                <span class="flex items-center"><div class="w-3 h-3 bg-green-600 rounded-full mr-1"></div> Vendida</span>
            </div>

            <div id="cardListContainer" class="grid grid-cols-6 sm:grid-cols-8 gap-2 max-h-[60vh] overflow-y-auto p-1">
                </div>

            <div class="mt-4 border-t pt-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-600 font-bold">Total a Pagar:</span>
                    <span id="totalCostDisplay" class="text-2xl font-black text-green-600">Bs. 0,00</span>
                </div>
                <button onclick="preparePayment()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition">
                    CONTINUAR A PAGO
                </button>
            </div>
        </div>
    </div>

    <div id="cardPreviewModal" class="modal">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Tabla N¬∞ <span id="previewNum" class="text-purple-600"></span></h3>
            <div id="previewImgContainer" class="flex justify-center mb-4 p-2 bg-gray-100 rounded-lg"></div>
            <p id="previewStatusText" class="font-bold mb-4"></p>
            <div class="flex gap-3 justify-center">
                <button id="btnPreviewAction" class="flex-1 py-2 bg-green-500 text-white font-bold rounded-lg shadow">LO QUIERO</button>
                <button onclick="closePreview()" class="flex-1 py-2 bg-gray-300 text-gray-700 font-bold rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="paymentProcessModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-purple-800">Confirmar Pago</h3>
                <button onclick="hidePaymentModal()" class="text-2xl">&times;</button>
            </div>
            
            <div class="bg-yellow-50 text-yellow-800 p-2 rounded text-center text-sm font-bold mb-4 border border-yellow-200">
                ‚è≥ Tienes <span id="paymentTimer" class="text-red-600 text-lg">05:00</span> para enviar el capture.
            </div>

            <div class="space-y-3 mb-4">
                <div class="flex justify-between text-sm border-b border-dashed pb-1">
                    <span>Tablas:</span> <span id="payCardsList" class="font-bold text-purple-700"></span>
                </div>
                <div class="flex justify-between text-sm border-b border-dashed pb-1">
                    <span>Total:</span> <span id="payTotal" class="font-bold text-green-600 text-lg"></span>
                </div>
            </div>

            <form id="paymentForm" onsubmit="event.preventDefault(); submitPayment();" class="space-y-3">
                <input type="text" id="payName" placeholder="Nombre y Apellido" class="w-full p-3 border rounded bg-gray-50" required>
                <input type="tel" id="payPhone" placeholder="Tel√©fono (WhatsApp)" class="w-full p-3 border rounded bg-gray-50" required>
                <input type="number" id="payRef" placeholder="√öltimos 4 d√≠gitos Referencia" class="w-full p-3 border rounded bg-gray-50" required>
                
                <div class="border-2 border-dashed border-purple-300 rounded-lg p-4 text-center bg-purple-50 cursor-pointer relative">
                    <input type="file" id="payFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>
                    <p class="text-purple-600 font-bold text-sm">üì∏ Toca aqu√≠ para subir CAPTURE</p>
                    <p id="fileNameDisplay" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition">
                    ENVIAR COMPROBANTE üöÄ
                </button>
            </form>
            <p id="uploadStatus" class="text-center text-sm mt-2 font-bold hidden"></p>
        </div>
    </div>

    <div id="legalModal" class="modal">
        <div class="modal-legal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="legalModalTitle" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="hideLegalModal()" class="text-2xl text-gray-500">&times;</button>
            </div>
            
            <div id="legalModalBody" class="modal-legal-body text-sm text-gray-700">
                </div>

        </div>
    </div>
    <script>
        // ==========================================================
        // ============== CONFIGURACI√ìN BINGO ==============
        // ==========================================================
        const TOTAL_CARDS = 75;
        const CARD_PRICE = 300;
        const BINGO_DATE_STRING = 'December 11, 2025 19:00:00'; 
        const BINGO_DATE = new Date(BINGO_DATE_STRING).getTime(); 
        
        let selectedCards = JSON.parse(localStorage.getItem('omega_selected_cards')) || [];
        let liveData = {};
        let previewCard = null;
        let timerInterval;
        let adminClicks = 0;
        let isStoreOpen = true; 

        // ==========================================================
        // ============== üïπÔ∏è L√ìGICA DEL JUEGO DINO (VERSI√ìN TURBO) üïπÔ∏è ==============
        // ==========================================================
        
        const canvas = document.getElementById('dinoCanvas');
        const ctx = canvas.getContext('2d');
        let gameAnimationFrame;
        let gameScore = 0;
        
        // üöÄ AJUSTE DE VELOCIDAD AQU√ç
        let gameSpeed = 5; // EMPIEZA MUCHO M√ÅS R√ÅPIDO (Antes era 5)
        
        let isGaming = false;
        
        // Ajustar canvas
        canvas.width = 600;
        canvas.height = 200;

        // Entidades (GRAVEDAD M√ÅS FUERTE PARA SALTO R√ÅPIDO)
        let dino = { x: 50, y: 150, width: 30, height: 30, dy: 0, jumpPower: -15, gravity: 0.8, grounded: true };
        let obstacles = [];
        let frameCount = 0;

        // Dibujar Pixel Art Simple
        function drawPixelDino(x, y) {
            ctx.fillStyle = 'black';
            // Cuerpo
            ctx.fillRect(x, y, 30, 30);
            // Cabeza
            ctx.fillRect(x + 10, y - 10, 20, 20);
            // Ojo
            ctx.fillStyle = 'white';
            ctx.fillRect(x + 20, y - 5, 5, 5);
        }

        function drawCactus(x, y, w, h) {
            ctx.fillStyle = '#9333ea'; // Morado Omega
            ctx.fillRect(x, y, w, h);
            // Detalle
            ctx.fillStyle = '#7e22ce';
            ctx.fillRect(x+5, y+5, w-10, h-10);
        }

        function drawBird(x, y) {
            ctx.fillStyle = '#4b5563'; // Gris oscuro
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x+15, y+10);
            ctx.lineTo(x+30, y);
            ctx.lineTo(x+15, y-5);
            ctx.fill();
        }

        function spawnObstacle() {
            let type = Math.random() > 0.7 ? 'bird' : 'cactus';
            let obj = { x: canvas.width, type: type, passed: false };

            if(type === 'cactus') {
                obj.y = 150; 
                obj.width = 20 + Math.random() * 20;
                obj.height = 30 + Math.random() * 20; 
            } else {
                obj.y = 90 + Math.random() * 40; // Altura variable
                obj.width = 30;
                obj.height = 20;
            }
            obstacles.push(obj);
        }

        function updateGame() {
            if(!isGaming) return;

            // Limpiar
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Fondo Suelo
            ctx.beginPath();
            ctx.moveTo(0, 180);
            ctx.lineTo(canvas.width, 180);
            ctx.strokeStyle = '#ddd';
            ctx.stroke();

            // F√≠sica Dino
            dino.dy += dino.gravity;
            dino.y += dino.dy;

            // Colisi√≥n suelo
            if (dino.y > 150) {
                dino.y = 150;
                dino.dy = 0;
                dino.grounded = true;
            } else {
                dino.grounded = false;
            }

            drawPixelDino(dino.x, dino.y);

            // Obst√°culos
            frameCount++;
            if (frameCount % (100 - Math.floor(gameSpeed * 2)) === 0) {
                spawnObstacle();
            }

            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                if (obs.type === 'cactus') drawCactus(obs.x, obs.y, obs.width, obs.height);
                else drawBird(obs.x, obs.y);

                // Colisi√≥n
                if (
                    dino.x < obs.x + obs.width &&
                    dino.x + dino.width > obs.x &&
                    dino.y < obs.y + obs.height &&
                    dino.y + dino.height > obs.y
                ) {
                    gameOver();
                }

                // Puntaje
                if (obs.x + obs.width < dino.x && !obs.passed) {
                    gameScore += 10;
                    obs.passed = true;
                    document.getElementById('gameScore').innerText = gameScore;
                    
                    // üöÄ ACELERACI√ìN AGRESIVA
                    if(gameScore % 100 === 0) {
                        gameSpeed += 0.5; // Aumenta m√°s r√°pido
                    }
                }
            }
            
            // Limpiar obst√°culos viejos
            obstacles = obstacles.filter(obs => obs.x > -50);

            gameAnimationFrame = requestAnimationFrame(updateGame);
        }

        function jumpDino() {
            if (!isGaming) return;
            if (dino.grounded) {
                dino.dy = dino.jumpPower;
                dino.grounded = false;
            }
        }

        // Controles Teclado
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && isGaming) {
                jumpDino();
            }
        });

        function startGame() {
            document.getElementById('gameMessage').classList.add('hidden');
            gameScore = 0;
            // VELOCIDAD DE REINICIO
            gameSpeed = 5; 
            obstacles = [];
            dino.y = 150;
            dino.dy = 0;
            isGaming = true;
            document.getElementById('gameScore').innerText = "0";
            updateGame();
        }

        function gameOver() {
            isGaming = false;
            cancelAnimationFrame(gameAnimationFrame);
            document.getElementById('msgTitle').innerText = "GAME OVER";
            document.getElementById('msgTitle').classList.add('text-red-600');
            document.querySelector('#gameMessage button').innerText = "INTENTAR DE NUEVO ‚Ü∫";
            document.getElementById('gameMessage').classList.remove('hidden');
        }

        function stopGameLogic() {
            isGaming = false;
            cancelAnimationFrame(gameAnimationFrame);
        }

        // ================== INICIALIZACI√ìN GENERAL ==================
        window.onload = () => {
            document.getElementById('bingoDateDisplay').textContent = new Date(BINGO_DATE).toLocaleDateString('es-ES', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });

            startRealtimeSync();
            startBingoTimer();
            checkStoreStatus(); 
            
            const pendingTimer = localStorage.getItem('omega_payment_start');
            if (pendingTimer && selectedCards.length > 0) {
                 startPaymentTimer(); 
            }

            document.getElementById('payFile').addEventListener('change', function(e) {
                if(this.files[0]) document.getElementById('fileNameDisplay').textContent = this.files[0].name;
            });
        };

        function saveLocalSelection() {
            localStorage.setItem('omega_selected_cards', JSON.stringify(selectedCards));
        }

        // ----------------------------------------------------
        // =========== L√ìGICA DE TIENDA + JUEGO INTEGRADO ==========
        // ----------------------------------------------------
        
        function checkStoreStatus() {
            db.collection('config').doc('general').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    isStoreOpen = data.isStoreOpen;
                } else {
                    db.collection('config').doc('general').set({ isStoreOpen: true });
                    isStoreOpen = true;
                }
                updateStoreUI();
            });
        }

        function updateStoreUI() {
            const overlay = document.getElementById('closedStoreOverlay');
            const currentUser = auth.currentUser;
            const btn = document.getElementById('toggleStoreBtn');
            const statusText = document.getElementById('storeStatusText');

            if(btn) {
                if(isStoreOpen) {
                    btn.textContent = "CERRAR TIENDA üîí";
                    btn.className = "px-6 py-3 rounded-lg font-black text-white transition-colors shadow-lg bg-red-600 hover:bg-red-700";
                    statusText.textContent = "La tienda est√° ABIERTA al p√∫blico.";
                    statusText.className = "text-sm text-green-600 font-bold";
                } else {
                    btn.textContent = "ABRIR TIENDA üîì";
                    btn.className = "px-6 py-3 rounded-lg font-black text-white transition-colors shadow-lg bg-green-600 hover:bg-green-700";
                    statusText.textContent = "La tienda est√° CERRADA al p√∫blico.";
                    statusText.className = "text-sm text-red-600 font-bold";
                }
            }

            if (!isStoreOpen && !currentUser) {
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // üõë NO iniciamos el juego autom√°ticamente para no consumir bater√≠a hasta que den click en JUGAR
            } else {
                overlay.style.display = 'none';
                document.body.style.overflow = 'auto';
                stopGameLogic(); // Detener juego si se abre la tienda
            }
        }

        function toggleStoreStatus() {
            const newState = !isStoreOpen;
            if(confirm(newState ? "¬øABRIR la tienda al p√∫blico?" : "¬øCERRAR la tienda? Nadie podr√° comprar.")) {
                db.collection('config').doc('general').set({ isStoreOpen: newState }, { merge: true })
                .catch(err => alert("Error al cambiar estado: " + err.message));
            }
        }

        // Trigger Secreto Admin en Overlay (Candado)
        let lockClicks = 0;
        document.getElementById('adminSecretLock').addEventListener('click', () => {
            lockClicks++;
            if(lockClicks >= 6) {
                document.getElementById('closedStoreOverlay').style.display = 'none'; 
                stopGameLogic();
                document.getElementById('clientContent').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adminLogin').classList.remove('hidden');
                lockClicks = 0;
            }
        });


        // ----------------------------------------------------
        // =========== SINCRONIZACI√ìN Y LIVE DATA ==========
        // ----------------------------------------------------

        function startRealtimeSync() {
            db.collection('ventasConfirmadas').onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    const d = change.doc.data();
                    (d.cards || []).forEach(c => {
                        if(change.type === 'removed') delete liveData[c];
                        else liveData[c] = { status: 'sold', ...d };
                    });
                });
                updateUI();
                if(auth.currentUser) renderAdminSoldList();
            });

            db.collection('reservasPendientes').onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    const d = change.doc.data();
                    const docId = change.doc.id; 
                    
                    (d.cards || []).forEach(c => {
                        const isSold = liveData[c]?.status === 'sold';
                        if(change.type === 'removed') {
                            if (!isSold) delete liveData[c];
                        } else {
                            if(!isSold) liveData[c] = { status: 'reserved', reservationId: docId, ...d };
                        }
                    });
                });
                updateUI();
                if(auth.currentUser) renderAdminPendingList();
            });

            auth.onAuthStateChanged(u => {
                updateStoreUI(); 
                if(u) {
                    document.getElementById('clientContent').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    renderAdminPendingList();
                    renderAdminSoldList();
                } else {
                    document.getElementById('clientContent').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('hidden');
                }
            });
        }

        // FUNCI√ìN DE ACTUALIZACI√ìN DE LA UI
        function updateUI() {
            let sold = 0;
            for(let i=1; i<=TOTAL_CARDS; i++) {
                if(liveData[i]?.status === 'sold') sold++;
            }
            document.getElementById('availableCount').textContent = TOTAL_CARDS - sold;
            
            const selectionModal = document.getElementById('cardSelectionModal');
            if(selectionModal && selectionModal.style.display === 'flex') {
                renderGrid();
            }

            if(document.getElementById('paymentProcessModal').style.display === 'flex') {
                checkPaymentConflicts();
            }
        }

        function checkPaymentConflicts() {
            let conflicts = [];
            let newSelection = [];
            selectedCards.forEach(card => {
                const status = getStatus(card);
                if (status === 'sold' || status === 'reserved') conflicts.push(card);
                else newSelection.push(card);
            });

            if (conflicts.length > 0) {
                alert(`‚ö†Ô∏è ¬°ATENCI√ìN! El n√∫mero(s) ${conflicts.join(', ')} acaba de ser comprado/reservado por otro jugador. Estos n√∫meros han sido retirados de tu lista.`);
                selectedCards = newSelection;
                saveLocalSelection();

                if (selectedCards.length === 0) {
                    hidePaymentModal(); 
                    localStorage.removeItem('omega_payment_start'); 
                } else {
                    document.getElementById('payCardsList').textContent = selectedCards.join(', ');
                    document.getElementById('payTotal').textContent = `Bs. ${(selectedCards.length * CARD_PRICE).toFixed(2)}`;
                }
            }
        }

        function showCardSelectionModal() {
            document.getElementById('cardPreviewModal').style.display = 'none';
            document.getElementById('paymentProcessModal').style.display = 'none';
            document.getElementById('legalModal').style.display = 'none'; 
            const modal = document.getElementById('cardSelectionModal');
            modal.style.display = 'flex'; 
            renderGrid();
            updateTotal();
            if(selectedCards.length > 0 && localStorage.getItem('omega_payment_start')) {
                startPaymentTimer();
            } else {
                clearInterval(timerInterval);
            }
        }

        function hideCardSelectionModal() {
            document.getElementById('cardSelectionModal').style.display = 'none';
        }

        function getStatus(n) {
            if(liveData[n]?.status === 'sold') return 'sold';
            if(liveData[n]?.status === 'reserved') return 'reserved';
            if(selectedCards.includes(n)) return 'selected'; 
            return 'available';
        }

        function renderGrid() {
            const container = document.getElementById('cardListContainer');
            container.innerHTML = '';
            for(let i=1; i<=TOTAL_CARDS; i++) {
                const st = getStatus(i);
                let tag = 'VER';
                if(st === 'sold') tag = 'VENDIDA';
                if(st === 'reserved') tag = 'OCUPADA'; 
                if(st === 'selected') tag = 'TUYA'; 

                const div = document.createElement('div');
                div.className = `card-item-container status-${st}`;
                
                div.innerHTML = `
                    <div class="bingo-ball" onclick="handleBallClick(${i}, '${st}')">${i}</div>
                    <span class="ver-tag" onclick="event.stopPropagation(); openPreview(${i})">${tag}</span>
                `;
                container.appendChild(div);
            }
        }
        
        function handleBallClick(n, st) {
            if(st === 'sold' || st === 'reserved') {
                openPreview(n);
            } else {
                if(selectedCards.includes(n)) selectedCards = selectedCards.filter(x => x !== n);
                else {
                    if (liveData[n]?.status === 'sold' || liveData[n]?.status === 'reserved') {
                         openPreview(n);
                         return;
                    }
                    selectedCards.push(n);
                }
                saveLocalSelection(); 
                updateTotal();
                renderGrid(); 
            }
        }

        function updateTotal() {
            const tot = selectedCards.length * CARD_PRICE;
            document.getElementById('totalCostDisplay').textContent = `Bs. ${tot.toFixed(2)}`;
        }

        function openPreview(n) {
            previewCard = n;
            const st = getStatus(n);
            const d = liveData[n];
            const btn = document.getElementById('btnPreviewAction');
            const txt = document.getElementById('previewStatusText');
            
            document.getElementById('previewNum').textContent = n;
            document.getElementById('previewImgContainer').innerHTML = `<img src="./tablas/tabla_${n}.png" class="bingo-card-image" onerror="this.src='https://placehold.co/300?text=Tabla+${n}'">`;
            
            if(st === 'sold') {
                txt.textContent = `‚ùå VENDIDA. (${d.name || 'Otro jugador'})`;
                txt.className = "text-red-600 font-bold mb-4";
                btn.style.display = 'none';
            } else if(st === 'reserved') {
                txt.textContent = `‚è≥ OCUPADA. (${d.name || 'Otro jugador'}) Esperando confirmaci√≥n de pago.`;
                txt.className = "text-orange-500 font-bold mb-4";
                btn.style.display = 'none';
            } else {
                const isSel = selectedCards.includes(n);
                txt.textContent = isSel ? "¬øYa no quieres esta tabla?" : "¬øTe gusta esta tabla?";
                txt.className = "text-gray-700 font-bold mb-4";
                btn.style.display = 'block';
                btn.textContent = isSel ? "QUITAR DE MI LISTA" : "AGREGAR A MI LISTA";
                btn.className = isSel ? "flex-1 py-2 bg-red-500 text-white font-bold rounded-lg" : "flex-1 py-2 bg-green-500 text-white font-bold rounded-lg";
                btn.onclick = () => {
                    if(isSel) selectedCards = selectedCards.filter(x => x !== n);
                    else selectedCards.push(n);
                    
                    saveLocalSelection();
                    updateTotal();
                    closePreview();
                    showCardSelectionModal();
                };
            }
            
            document.getElementById('cardSelectionModal').style.display = 'none';
            document.getElementById('cardPreviewModal').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('cardPreviewModal').style.display = 'none';
            showCardSelectionModal();
        }

        // ================== CLIENTE: PAGO ==================
        function preparePayment() {
            if(selectedCards.length === 0) return alert("Selecciona al menos una tabla");
            
            const cardsToCheck = [...selectedCards];
            let conflictDuringSelection = false;
            for (const card of cardsToCheck) {
                if (liveData[card] && (liveData[card].status === 'sold' || liveData[card].status === 'reserved')) {
                    selectedCards = selectedCards.filter(x => x !== card);
                    conflictDuringSelection = true;
                }
            }
            if (conflictDuringSelection) {
                 saveLocalSelection();
                 updateTotal();
                 alert("‚ö†Ô∏è Una o m√°s de tus tablas fueron reservadas o vendidas mientras seleccionabas. Han sido eliminadas de tu lista.");
            }

            if (selectedCards.length === 0) {
                 hideCardSelectionModal();
                 return; 
            }
            
            document.getElementById('payName').value = '';
            document.getElementById('payPhone').value = '';
            document.getElementById('payRef').value = '';
            document.getElementById('fileNameDisplay').textContent = '';

            if (!localStorage.getItem('omega_payment_start')) {
                localStorage.setItem('omega_payment_start', Date.now());
            }

            hideCardSelectionModal();
            document.getElementById('paymentProcessModal').style.display = 'flex';
            
            document.getElementById('payCardsList').textContent = selectedCards.join(', ');
            document.getElementById('payTotal').textContent = `Bs. ${(selectedCards.length * CARD_PRICE).toFixed(2)}`;
            
            startPaymentTimer();
        }

        function startPaymentTimer() {
            const display = document.getElementById('paymentTimer');
            clearInterval(timerInterval);
            
            const startTime = parseInt(localStorage.getItem('omega_payment_start'));
            if (!startTime) return; 

            timerInterval = setInterval(() => {
                const now = Date.now();
                const elapsedSeconds = Math.floor((now - startTime) / 1000);
                const totalDuration = 300; // 5 minutos
                let remaining = totalDuration - elapsedSeconds;

                if (remaining < 0) remaining = 0;

                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                display.textContent = `0${m}:${s<10?'0'+s:s}`;

                if(remaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Lo siento, su tiempo de compra se ha agotado. Las tablas han sido liberadas.");
                    
                    localStorage.removeItem('omega_payment_start');
                    selectedCards = []; 
                    localStorage.removeItem('omega_selected_cards');
                    
                    hidePaymentModal();
                    updateUI();
                }
            }, 1000);
        }

        function hidePaymentModal() {
            document.getElementById('paymentProcessModal').style.display = 'none';
            showCardSelectionModal();
        }

        async function submitPayment() {
            const YOUR_CLOUD_NAME = "dcenrp74j"; 
            const YOUR_UPLOAD_PRESET = "bingo_comprobantes"; 
            
            const name = document.getElementById('payName').value;
            const phone = document.getElementById('payPhone').value.replace(/\D/g,'');
            const ref = document.getElementById('payRef').value;
            const file = document.getElementById('payFile').files[0];
            const statusMsg = document.getElementById('uploadStatus');

            if(!name || phone.length < 10 || !ref || !file) {
                statusMsg.textContent = "Datos incompletos o tel√©fono inv√°lido.";
                statusMsg.className = "text-center text-sm mt-2 font-bold text-red-600 block";
                return;
            }

            for (const card of selectedCards) {
                if (liveData[card] && liveData[card].status === 'sold') {
                    statusMsg.textContent = `Error: La tabla N¬∞ ${card} fue VENDIDA. Reinicia tu selecci√≥n.`;
                    statusMsg.className = "text-center text-sm mt-2 font-bold text-red-600 block";
                    return;
                }
            }

            statusMsg.textContent = "Subiendo comprobante... ‚è≥";
            statusMsg.className = "text-center text-sm mt-2 font-bold text-blue-600 block";

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', YOUR_UPLOAD_PRESET);
                formData.append('public_id', `${phone}_${Date.now()}`); 
                const uploadUrl = `https://api.cloudinary.com/v1_1/${YOUR_CLOUD_NAME}/image/upload`;

                const response = await fetch(uploadUrl, { method: 'POST', body: formData });
                const data = await response.json();
                const url = data.secure_url; 
                
                if (!response.ok || !url) throw new Error(data.error ? data.error.message : response.statusText);

                const newDocRef = await db.collection('reservasPendientes').add({ 
                    name: name,
                    phone: phone,
                    reference: ref,
                    proofURL: url, 
                    cards: selectedCards,
                    totalAmount: selectedCards.length * CARD_PRICE,
                    timestamp: Date.now(),
                    status: 'PENDING_CONFIRMATION'
                });

                selectedCards.forEach(c => {
                    liveData[c] = { status: 'reserved', reservationId: newDocRef.id, name: name, phone: phone };
                });
                
                statusMsg.textContent = "¬°Enviado! üéâ";
                confetti({ particleCount: 100, spread: 70 });
                
                selectedCards = [];
                localStorage.removeItem('omega_selected_cards');
                localStorage.removeItem('omega_payment_start');
                clearInterval(timerInterval);

                setTimeout(() => {
                    hidePaymentModal();
                    alert("Tu pago ha sido enviado. Espera la confirmaci√≥n del administrador. Las tablas han sido reservadas (OCUPADAS).");
                }, 1500);

            } catch(e) {
                console.error("Error al subir:", e);
                statusMsg.textContent = `Error: ${e.message || 'Fallo de red/Cloudinary.'}`;
                statusMsg.className = "text-center text-sm mt-2 font-bold text-red-600 block";
            }
        }

        // ================== CONSULTAS ==================
        async function searchCardByPhone() {
            const p = document.getElementById('searchPhoneInput').value.replace(/\D/g,'');
            if(p.length < 10) return alert("Tel√©fono inv√°lido");
            const div = document.getElementById('searchResultArea');
            const content = document.getElementById('resultContent');
            div.classList.remove('hidden');
            content.innerHTML = 'Buscando...';
            
            let found = [];
            const soldSnap = await db.collection('ventasConfirmadas').where('phone', '==', p).get();
            soldSnap.forEach(doc => { doc.data().cards.forEach(c => found.push({n:c, st:'VENDIDA', col:'green'})); });
            const pendSnap = await db.collection('reservasPendientes').where('phone', '==', p).get();
            pendSnap.forEach(doc => { doc.data().cards.forEach(c => found.push({n:c, st:'EN REVISI√ìN', col:'orange'})); });

            content.innerHTML = '';
            if(found.length === 0) content.innerHTML = '<p>No se encontraron tablas asociadas a este tel√©fono.</p>';
            else {
                document.getElementById('resultTitle').textContent = `Jugador: ${p}`;
                const uniqueCards = [...new Set(found.map(f => f.n))].map(n => {
                    const status = found.filter(f => f.n === n).map(f => f.st).includes('VENDIDA') ? 'VENDIDA' : 'EN REVISI√ìN';
                    const col = status === 'VENDIDA' ? 'green' : 'orange';
                    return { n, st: status, col };
                });

                uniqueCards.forEach(f => {
                    content.innerHTML += `<div class="bg-${f.col}-100 border border-${f.col}-500 p-2 rounded"><span class="text-2xl font-black text-${f.col}-700">${f.n}</span><br><span class="text-xs font-bold text-${f.col}-800">${f.st}</span></div>`;
                });
            }
        }


        function searchCard() {
            const n = parseInt(document.getElementById('cardNumberInput').value);
            if(!n) return;
            const div = document.getElementById('searchResultArea');
            const content = document.getElementById('resultContent');
            div.classList.remove('hidden');
            const d = liveData[n];
            const st = d ? (d.status === 'sold' ? 'VENDIDA' : 'RESERVADA') : 'DISPONIBLE';
            const col = d ? (d.status === 'sold' ? 'green' : 'orange') : 'purple';
            document.getElementById('resultTitle').textContent = `Tabla #${n}`;
            content.innerHTML = `<div class="text-center"><img src="./tablas/tabla_${n}.png" class="bingo-card-image w-48 mx-auto mb-2" onerror="this.src='https://placehold.co/200?text=${n}'"><p class="font-bold text-${col}-600 text-xl">${st}</p>${d && d.name ? `<p class="text-sm text-gray-600">Jugador: ${d.name}</p>` : ''}<a href="./tablas/tabla_${n}.png" download class="inline-block mt-2 bg-purple-600 text-white px-4 py-1 rounded">Descargar</a></div>`;
        }

        function copyToClipboard(txt) { navigator.clipboard.clipboard.writeText(txt); alert("Copiado!"); }

        // ================== ADMIN ACCESO Y RENDER ==================
        document.getElementById('footer-logo').addEventListener('click', () => {
            adminClicks++;
            if(adminClicks >= 6) {
                document.getElementById('clientContent').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                if(auth.currentUser) {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                }
                adminClicks = 0;
            }
        });

        function adminLogin() {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPassword').value;
            auth.signInWithEmailAndPassword(e, p).then(() => {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                renderAdminPendingList(); renderAdminSoldList();
            }).catch(err => document.getElementById('adminLoginError').textContent = err.message);
        }

        function adminLogout() { auth.signOut().then(() => location.reload()); }

        function renderAdminPendingList() {
            db.collection('reservasPendientes').where('status', '==', 'PENDING_CONFIRMATION').onSnapshot(snap => {
                const div = document.getElementById('pendingCardsList');
                div.innerHTML = '';
                document.getElementById('pendingCount').textContent = snap.size;
                snap.forEach(doc => {
                    const d = doc.data();
                    div.innerHTML += `<div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-400"><div class="flex justify-between mb-2"><span class="font-bold text-gray-800">${d.name}</span><span class="text-sm bg-gray-200 px-2 rounded">${d.phone}</span></div><p class="text-sm text-gray-600 mb-1">Ref: <b>${d.reference}</b> | Bs. ${d.totalAmount}</p><p class="text-sm mb-2">Tablas: <b class="text-purple-600">${d.cards.join(', ')}</b></p><a href="${d.proofURL}" target="_blank" class="block text-center bg-blue-50 text-blue-600 py-1 rounded text-sm font-bold mb-3 border border-blue-200">Ver Comprobante</a><div class="flex gap-2"><button onclick="confirmSale('${doc.id}')" class="flex-1 bg-green-500 text-white py-2 rounded font-bold hover:bg-green-600">APROBAR</button><button onclick="rejectSale('${doc.id}')" class="flex-1 bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600">RECHAZAR</button></div></div>`;
                });
            });
        }

        function renderAdminSoldList() {
            db.collection('ventasConfirmadas').orderBy('saleDate', 'desc').limit(50).onSnapshot(snap => {
                const tbody = document.getElementById('soldPlayersTableBody');
                tbody.innerHTML = '';
                document.getElementById('soldCount').textContent = snap.size;
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-bold">${d.name}</td><td class="p-3 text-xs">${d.phone}</td><td class="p-3 text-green-600 font-bold text-xs break-all">${d.cards.join(',')}</td><td class="p-3"><button onclick="deleteSale('${doc.id}')" class="text-red-500 text-xs underline">Eliminar</button></td></tr>`;
                });
            });
        }

        function confirmSale(id) {
            if(!confirm("¬øConfirmar pago y vender tablas? Esto verificar√° la disponibilidad final.")) return;

            db.collection('reservasPendientes').doc(id).get().then(doc => {
                if (!doc.exists) return alert("Error: La reserva ya no existe.");
                const d = doc.data();
                
                let conflict = false;
                let cardsToSell = [];

                d.cards.forEach(cardNum => {
                    const currentStatus = liveData[cardNum]?.status;
                    const currentReservationId = liveData[cardNum]?.reservationId;

                    if (currentStatus === 'sold') {
                        conflict = true;
                    } else if (currentStatus === 'reserved' && currentReservationId !== id) {
                        conflict = true;
                    } else {
                        cardsToSell.push(cardNum);
                    }
                });
                
                if (conflict) {
                    alert(`‚õî ERROR DE INTEGRIDAD: Se detect√≥ que algunas tablas ya est√°n Vendidas o Reservadas por otro. Solo se intentar√°n confirmar las disponibles (${cardsToSell.join(', ')}).`);
                }

                if (cardsToSell.length === 0) {
                     alert("üö´ Ninguna de las tablas de esta reserva est√° disponible para la venta. El registro se eliminar√° de 'Pendientes'.");
                }
                
                const batch = db.batch();
                
                if (cardsToSell.length > 0) {
                    batch.set(db.collection('ventasConfirmadas').doc(), { 
                        name: d.name, 
                        phone: d.phone, 
                        cards: cardsToSell,
                        saleDate: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                }
                
                batch.delete(db.collection('reservasPendientes').doc(id));
                
                batch.commit().then(() => {
                    if (cardsToSell.length > 0) {
                        alert(`Venta confirmada exitosamente. Tablas vendidas: ${cardsToSell.join(', ')}.`);
                    } else {
                        alert("Reserva eliminada. No se pudo vender ninguna tabla por conflicto.");
                    }
                }).catch(e => {
                    console.error("Error al confirmar venta:", e);
                    alert("Hubo un error al confirmar la venta.");
                });
            });
        }

        function rejectSale(id) { 
            if(confirm("¬øRechazar y liberar tablas?")) {
                db.collection('reservasPendientes').doc(id).delete().then(() => {
                    alert("Reserva rechazada y tablas liberadas.");
                }).catch(e => console.error("Error al rechazar:", e));
            }
        }
        
        function deleteSale(id) { 
            if(confirm("¬øEliminar venta? Las tablas quedar√°n libres.")) {
                db.collection('ventasConfirmadas').doc(id).delete().then(() => {
                    alert("Venta eliminada. Las tablas ser√°n marcadas como disponibles.");
                }).catch(e => console.error("Error al eliminar venta:", e));
            }
        }
        
        function downloadSoldList() {
            db.collection('ventasConfirmadas').get().then(snap => {
                let csv = "Nombre,Telefono,Tablas\n";
                snap.forEach(doc => { 
                    const d = doc.data(); 
                    csv += `${d.name || ''},${d.phone || ''},"${(d.cards || []).join(';')}"\n`; 
                });
                const blob = new Blob([csv],{type:'text/csv'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'ventas_omega.csv';
                a.click();
            });
        }

        function startBingoTimer() {
            const countdownDisplay = document.getElementById('countdownTimer');

            const timerFunction = () => {
                const now = new Date().getTime();
                const dist = BINGO_DATE - now;

                if (dist < 0) {
                    countdownDisplay.textContent = "¬°JUEGO EN VIVO! üéâ";
                    return;
                }

                const oneSecond = 1000;
                const oneMinute = oneSecond * 60;
                const oneHour = oneMinute * 60;
                const oneDay = oneHour * 24;

                const days = Math.floor(dist / oneDay);
                const hours = Math.floor((dist % oneDay) / oneHour);
                const minutes = Math.floor((dist % oneHour) / oneMinute);
                const seconds = Math.floor((dist % oneMinute) / oneSecond);

                const dDisplay = days > 0 ? `${days}D ` : '';
                const hDisplay = String(hours).padStart(2, '0');
                const mDisplay = String(minutes).padStart(2, '0');
                const sDisplay = String(seconds).padStart(2, '0');

                countdownDisplay.textContent = `${dDisplay}${hDisplay}:${mDisplay}:${sDisplay}`;
            };

            timerFunction();
            setInterval(timerFunction, 1000);
        }

        // ==========================================================
        // ============== FUNCIONES LEGALES ==============
        // ==========================================================

        const legalContent = {
            // COMENTARIO: Aseg√∫rate de reemplazar "[Nombre de tu P√°gina de Bingo]" y "[Fecha Actual]"
            terms: `
                <h2 class="text-xl font-bold text-gray-900 mb-3">T√©rminos y Condiciones del Servicio OMEGA Bingo</h2>
                <p class="text-xs text-gray-500 mb-4">√öltima actualizaci√≥n: 04/12/25</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">1. Aceptaci√≥n de los T√©rminos</h3>
                <p>Al acceder y utilizar los servicios de OMEGA Bingo, usted acepta estar sujeto a estos T√©rminos y Condiciones, as√≠ como a nuestra Pol√≠tica de Privacidad.</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">2. Uso de la Cuenta y Seguridad</h3>
                <p>Usted es responsable de mantener la confidencialidad de su contrase√±a y de todas las actividades que ocurran bajo su cuenta. Se compromete a notificarnos inmediatamente sobre cualquier uso no autorizado de su cuenta.</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">3. Jurisdicci√≥n y Uso Legal (Venezuela / EEUU)</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li><strong>Juegos de Azar:</strong> Al participar, usted declara que cumple con la mayor√≠a de edad legal para participar en juegos de azar en su jurisdicci√≥n. Es su responsabilidad asegurarse de que la participaci√≥n en bingos en l√≠nea es legal en su lugar de residencia, tanto en Venezuela como en Estados Unidos, o cualquier otra ubicaci√≥n.</li>
                    <li><strong>Riesgo:</strong> La participaci√≥n es bajo su propio riesgo. OMEGA Bingo no se hace responsable por cualquier p√©rdida incurrida.</li>
                </ul>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">4. Verificaci√≥n y Documentaci√≥n del Cliente</h3>
                <p>Para garantizar la integridad del juego y la seguridad de las transacciones, podemos solicitar documentaci√≥n adicional (como comprobantes de pago o identificaci√≥n) para verificar su identidad y sus reservas. Esta informaci√≥n ser√° tratada de acuerdo con nuestra Pol√≠tica de Privacidad.</p>

                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">5. Uso del C√≥digo y Licencia</h3>
                <p>El c√≥digo fuente y los elementos de dise√±o (im√°genes, logos, etc.) de esta plataforma son propiedad privada de OMEGA Bingo Masson¬© o sus licenciatarios. El acceso a este sistema est√° estrictamente limitado al uso como cliente para la compra de tablas. Queda terminantemente prohibida la copia, reproducci√≥n, distribuci√≥n, ingenier√≠a inversa o cualquier uso no autorizado del c√≥digo privado de la p√°gina web sin el consentimiento expreso y por escrito de los propietarios de OMEGA Bingo.</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">6. Limitaci√≥n de Responsabilidad</h3>
                <p>OMEGA Bingo no se hace responsable de las p√©rdidas o da√±os que surjan de la falta de medidas de seguridad adecuadas en los dispositivos del usuario, o de fallos t√©cnicos fuera de nuestro control razonable, incluyendo interrupciones en el servicio de Internet, fallos de red o errores de pago m√≥vil de terceros.</p>
                `,
            privacy: `
                <h2 class="text-xl font-bold text-gray-900 mb-3">Pol√≠tica de Privacidad de OMEGA Bingo</h2>
                <p class="text-xs text-gray-500 mb-4">√öltima actualizaci√≥n: 4/12/25</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">1. Informaci√≥n que Recopilamos</h3>
                <p>Recopilamos informaci√≥n que usted nos proporciona directamente al registrarse, reservar n√∫meros y realizar pagos. Esto puede incluir su nombre, direcci√≥n de correo electr√≥nico, n√∫mero de tel√©fono, detalles de pago y los documentos de verificaci√≥n (como comprobantes de pago) que nos env√≠e.</p>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">2. Uso de la Informaci√≥n y Cumplimiento Legal</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Procesar sus reservas y pagos.</li>
                    <li>Verificar su identidad y elegibilidad para jugar.</li>
                    <li>Comunicarnos con usted sobre el estado de su cuenta y premios.</li>
                    <li>Cumplir con nuestras obligaciones legales y reglamentarias, especialmente las relacionadas con la prevenci√≥n de fraude y el juego responsable, en las jurisdicciones aplicables (incluyendo Venezuela y EEUU).</li>
                </ul>

                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">3. Almacenamiento y Seguridad de los Datos (Clave de Confianza)</h3>
                <p>La seguridad de su informaci√≥n personal es nuestra prioridad. Implementamos medidas de seguridad t√©cnicas y organizativas robustas para proteger los datos contra el acceso no autorizado, la alteraci√≥n, la divulgaci√≥n o la destrucci√≥n.</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li><strong>Alojamiento Seguro:</strong> Todos los datos y documentos de verificaci√≥n (comprobantes de pago) se almacenan en servidores seguros operados por proveedores de servicios certificados que cumplen con est√°ndares de seguridad reconocidos internacionalmente ISO 27001., que manejan la informaci√≥n de acuerdo a est√°ndares globales.</li>
                    <li><strong>Cifrado:</strong> Utilizamos el cifrado de datos (SSL/TLS) para proteger la transmisi√≥n de datos entre su navegador y nuestros servidores. Los datos almacenados tambi√©n est√°n sujetos a medidas de cifrado en reposo cuando es posible.</li>
                    <li><strong>Acceso Restringido:</strong> El acceso a la informaci√≥n personal identificable est√° estrictamente limitado al personal autorizado de OMEGA Bingo que requiere acceso para realizar sus funciones laborales.</li>
                    <li><strong>Gesti√≥n de Documentos:</strong> Los comprobantes de clientes se almacenan en un sistema de gesti√≥n de documentos seguro e interno (Cloudinary privado) y nunca en servicios de alojamiento de archivos p√∫blicos o gen√©ricos como MediaFire, Google Drive personal o Dropbox personal.</li>
                </ul>
                
                <h3 class="font-bold text-lg text-purple-700 mt-4 mb-2">4. Retenci√≥n de Datos</h3>
                <p>Retenemos su informaci√≥n personal solo durante el tiempo necesario para cumplir con los fines para los que fue recopilada, incluyendo cualquier per√≠odo de retenci√≥n legal o reglamentario requerido por las autoridades de licencias de juego y fiscales.</p>
                `
        };

        function showLegalModal(type) {
            const modal = document.getElementById('legalModal');
            const title = document.getElementById('legalModalTitle');
            const body = document.getElementById('legalModalBody');

            if (type === 'terms') {
                title.textContent = 'T√©rminos y Condiciones';
                body.innerHTML = legalContent.terms;
            } else if (type === 'privacy') {
                title.textContent = 'Pol√≠tica de Privacidad';
                body.innerHTML = legalContent.privacy;
            } else {
                return;
            }
            
            modal.style.display = 'flex';
        }

        function hideLegalModal() {
            document.getElementById('legalModal').style.display = 'none';
        }
    </script>
</body>
</html>
